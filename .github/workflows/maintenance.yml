name: üßπ Maintenance & Cleanup

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ============================================
  # Dependency Updates Check
  # ============================================
  check-dependencies:
    name: üì¶ Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîç Check for outdated packages
        working-directory: ./playwright_ts
        run: |
          echo "## üì¶ Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated || true >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: üõ°Ô∏è Run security audit
        working-directory: ./playwright_ts
        run: |
          echo "## üõ°Ô∏è Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate || true

  # ============================================
  # Docker Image Cleanup
  # ============================================
  cleanup-docker:
    name: üêã Docker Image Cleanup
    runs-on: ubuntu-latest
    
    steps:
      - name: üßπ Clean up old Docker images
        run: |
          echo "Cleaning up Docker images older than 30 days..."
          # Add logic to clean up old Docker images from registry

  # ============================================
  # Artifact Cleanup
  # ============================================
  cleanup-artifacts:
    name: üì¶ Cleanup Old Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write
    
    steps:
      - name: üóëÔ∏è Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10

  # ============================================
  # Database Health Check
  # ============================================
  health-check:
    name: üè• System Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêã Start MongoDB
        run: |
          docker compose up -d mongo
          sleep 10

      - name: üîç Check MongoDB health
        run: |
          docker compose exec -T mongo mongosh --eval "db.adminCommand('ping')"

      - name: üìä Generate health report
        run: |
          echo "## üè• System Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- MongoDB: ‚úÖ Healthy" >> $GITHUB_STEP_SUMMARY
          echo "- Last check: $(date)" >> $GITHUB_STEP_SUMMARY

      - name: üßπ Cleanup
        if: always()
        run: docker compose down -v

  # ============================================
  # Code Quality Trends
  # ============================================
  quality-trends:
    name: üìà Code Quality Trends
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Analyze code metrics
        run: |
          echo "## üìà Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- Total commits: $(git rev-list --count HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "- Contributors: $(git log --format='%aN' | sort -u | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript files: $(find . -name '*.ts' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Test files: $(find . -name '*.test.ts' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent Activity (Last 7 days):" >> $GITHUB_STEP_SUMMARY
          echo "- Commits: $(git log --since='7 days ago' --oneline | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Files changed: $(git diff --name-only HEAD@{7.days.ago}..HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stale Issues & PRs
  # ============================================
  stale-check:
    name: üóÇÔ∏è Mark Stale Issues/PRs
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: üè∑Ô∏è Mark stale issues and PRs
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: 'This issue has been automatically marked as stale due to inactivity.'
          stale-pr-message: 'This PR has been automatically marked as stale due to inactivity.'
          close-issue-message: 'This issue was automatically closed due to prolonged inactivity.'
          close-pr-message: 'This PR was automatically closed due to prolonged inactivity.'
          days-before-stale: 60
          days-before-close: 14
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          exempt-issue-labels: 'keep-open,enhancement'
          exempt-pr-labels: 'keep-open,work-in-progress'