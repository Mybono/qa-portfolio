name: ğŸ” PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # PR Validation
  # ============================================
  pr-validation:
    name: âœ… PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          
          if [ $FILES_CHANGED -gt 50 ]; then
            echo "âš ï¸ Warning: PR changes more than 50 files"
          fi
          
          if [ $LINES_CHANGED -gt 1000 ]; then
            echo "âš ï¸ Warning: PR changes more than 1000 lines"
          fi

      - name: ğŸ·ï¸ Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check for conventional commit format
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .+'; then
            echo "âš ï¸ PR title doesn't follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, test, chore, perf"
          else
            echo "âœ… PR title follows conventional commits format"
          fi

      - name: ğŸ“ Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 20 ]; then
            echo "âš ï¸ PR description is too short or empty"
            exit 1
          else
            echo "âœ… PR has adequate description"
          fi

  # ============================================
  # Code Review Automation
  # ============================================
  auto-review:
    name: ğŸ¤– Automated Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Generate PR metrics
        run: |
          echo "## ğŸ“Š PR Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Files changed: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: $(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4}')" >> $GITHUB_STEP_SUMMARY
          echo "- Lines deleted: $(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $6}')" >> $GITHUB_STEP_SUMMARY
          echo "- Commits: $(git rev-list --count origin/${{ github.base_ref }}..HEAD)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Code Validation
        run: |
          echo "Running code quality checks..."
          npm ci
          npm run validate

  # ============================================
  # PR CheckMate Quality Checks
  # ============================================
  pr-checkmate:
    name: ğŸ“¦ PR CheckMate Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run PR CheckMate
        run: npx pr-checkmate all

  # ============================================
  # Auto Merge if author is Mybono
  # ============================================
  auto-merge:
    name: ğŸš€ Auto Merge PR
    runs-on: ubuntu-latest
    needs: [pr-validation, auto-review, pr-checkmate]
    if: github.actor == 'Mybono'
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4

      - name: ğŸ¤– Auto-merge PR
        uses: pascalgn/automerge-action@v0.14.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}