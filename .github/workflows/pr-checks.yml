name: ðŸ” PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # PR Validation
  # ============================================
  pr-validation:
    name: âœ… PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          
          if [ $FILES_CHANGED -gt 50 ]; then
            echo "âš ï¸ Warning: PR changes more than 50 files"
          fi
          
          if [ $LINES_CHANGED -gt 1000 ]; then
            echo "âš ï¸ Warning: PR changes more than 1000 lines"
          fi

      - name: ðŸ·ï¸ Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check for conventional commit format
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .+'; then
            echo "âš ï¸ PR title doesn't follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, test, chore, perf"
          else
            echo "âœ… PR title follows conventional commits format"
          fi

      - name: ðŸ“ Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 20 ]; then
            echo "âš ï¸ PR description is too short or empty"
            exit 1
          else
            echo "âœ… PR has adequate description"
          fi

  # ============================================
  # Code Review Automation
  # ============================================
  auto-review:
    name: ðŸ¤– Automated Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for common issues
        run: |
          echo "Checking for common code issues..."
          
          # Check for console.log in TypeScript files
          if git diff origin/${{ github.base_ref }}...HEAD -- '*.ts' | grep -q 'console\.log'; then
            echo "âš ï¸ Warning: Found console.log statements"
          fi
          
          # Check for TODO comments
          if git diff origin/${{ github.base_ref }}...HEAD | grep -q 'TODO'; then
            echo "âš ï¸ Warning: Found TODO comments"
          fi
          
          # Check for debugger statements
          if git diff origin/${{ github.base_ref }}...HEAD | grep -q 'debugger'; then
            echo "âŒ Error: Found debugger statements"
            exit 1
          fi
          
          echo "âœ… No critical issues found"

      - name: ðŸ“Š Generate PR metrics
        run: |
          echo "## ðŸ“Š PR Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Files changed: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: $(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4}')" >> $GITHUB_STEP_SUMMARY
          echo "- Lines deleted: $(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $6}')" >> $GITHUB_STEP_SUMMARY
          echo "- Commits: $(git rev-list --count origin/${{ github.base_ref }}..HEAD)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Dependency Check
  # ============================================
  dependency-check:
    name: ðŸ“¦ Dependency Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for dependency changes
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q 'package.*\.json'; then
            echo "## ðŸ“¦ Dependency Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ This PR modifies dependencies. Please ensure:" >> $GITHUB_STEP_SUMMARY
            echo "1. Security audit has been run" >> $GITHUB_STEP_SUMMARY
            echo "2. License compatibility is verified" >> $GITHUB_STEP_SUMMARY
            echo "3. Bundle size impact is acceptable" >> $GITHUB_STEP_SUMMARY
          fi
