name: üîç PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # PR Validation
  # ============================================
  pr-validation:
    name: ‚úÖ PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìè Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          
          if [ $FILES_CHANGED -gt 50 ]; then
            echo "‚ö†Ô∏è Warning: PR changes more than 50 files"
          fi
          
          if [ $LINES_CHANGED -gt 1000 ]; then
            echo "‚ö†Ô∏è Warning: PR changes more than 1000 lines"
          fi

      - name: üè∑Ô∏è Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check for conventional commit format
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .+'; then
            echo "‚ö†Ô∏è PR title doesn't follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, test, chore, perf"
          else
            echo "‚úÖ PR title follows conventional commits format"
          fi

      - name: üìù Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 20 ]; then
            echo "‚ö†Ô∏è PR description is too short or empty"
            exit 1 # This will fail the step
          else
            echo "‚úÖ PR has adequate description"
          fi

      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Generate PR metrics
        run: |
          echo "## üìä PR Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Files changed: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: $(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4}')" >> $GITHUB_STEP_SUMMARY
          echo "- Lines deleted: $(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $6}')" >> $GITHUB_STEP_SUMMARY
          echo "- Commits: $(git rev-list --count origin/${{ github.base_ref }}..HEAD)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PR CheckMate Quality Checks
  # ============================================
  pr-checkmate:
    name: ‚úÖ PR CheckMate
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
        
      - name: üì¶ Install project dependencies
        run: npm ci
      
      - name: üì¶ Install PR CheckMate globally
        run: npm install -g pr-checkmate@latest
        
      - name: üîç Run PR CheckMate
        run: pr-checkmate all

  # =======================================================
  # Update Changelog
  # =======================================================
  update-changelog:
    name: üìù Update Changelog
    runs-on: ubuntu-latest
    needs: [pr-checkmate, pr-validation]
    steps:
      - name: üì• Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üìù Determine bump type
        id: bump
        run: |
          if git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s" | grep -q "^feat:"; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          else
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          fi

      - name: üìù Generate/Update CHANGELOG.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          npx standard-version --skip.tag --skip.commit --release-as ${{ steps.bump.outputs.bump_type }}

          git add CHANGELOG.md package.json package-lock.json

          if ! git diff --cached --quiet; then
            git commit -m "docs: update CHANGELOG.md"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No changes to CHANGELOG.md"
          fi

  # =======================================================
  # Auto-merge PR 
  # =======================================================
  auto-merge:
    name: ü§ñ Auto-merge PR
    runs-on: ubuntu-latest
    needs: [update-changelog]
    if: github.repository == github.event.repository.full_name
    steps:
      - name: üîÄ Enable auto-merge
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --merge \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
